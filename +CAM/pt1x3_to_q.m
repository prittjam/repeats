function M = pt1x3_to_q(u,varargin)
cfg.solver = 'linear';
cfg = cmp_argparse(cfg,varargin{:});

switch cfg.solver
  case 'linear'
    M = pt1x3_to_q_linear(u);
  case 'polynomial'
    M = pt1x3_to_q_polynomial(u);
end

function M = pt1x3_to_q_linear(x)
u1 = x(1,:)';
v1 = x(2,:)';
u2 = x(4,:)';
v2 = x(5,:)';
u3 = x(7,:)';
v3 = x(8,:)';

A = ((u3.^2 + v3.^2).*(u1.*v2 - u2.*v1) + v3.*(u2.*(u1.^2 + v1.^2) - u1.*(u2.^2 + v2.^2)) - u3.*(v2.*(u1.^2 + v1.^2) - v1.*(u2.^2 + v2.^2)));
b = -1*(u1.*v2 - u2.*v1 - v3.*(u1 - u2) + u3.*(v1 - v2));

q = A\b;

M = { q };

function M = pt1x3_to_q_polynomial(u)
d = sum(u(1:2,:).^2);
Q = [u;d]*[u;d]';
Q = Q / norm(Q,'fro');
sols = solve(Q(:));

% find best solution
res = inf;
for i = 1:length(sols)
    uk = [u(1:2,:); 1+sols(i)*d];
    s = svd(uk);
    if s(3) < res
        k = sols(i);
        res = s(3);
    end
end

M = { k };

function sols = solve(data)
C = setup_elimination_template(data);
b_ind = [173,178,183,188];
b = zeros(4,47);
b(b_ind) = -1;
basis_ind = [48,49,50,51,52];
C0 = C; C0(:,basis_ind) = [];
C1 = C(:,basis_ind);
alpha = C0' \ b';
RR = [alpha'*C1;eye(5)];
AM_ind = [6,1,2,3,4];
AM = RR(AM_ind,:);
[V,D] = eig(AM);
V = V ./ (ones(size(V,1),1)*V(1,:));
sols = V(3,:);

function [coeffs,coeffs_ind] = compute_coeffs(data)

coeffs(1) = data(12) + data(15);
coeffs(2) = data(8) + data(14);
coeffs(3) = data(4) + data(13);
coeffs(4) = 2*data(16);
coeffs(5) = data(3) + data(9);
coeffs(6) = data(2) + data(5);
coeffs(7) = 2*data(1);
coeffs(8) = 2;
coeffs(9) = data(7) + data(10);
coeffs(10) = 2*data(6);
coeffs(11) = 2*data(11);
coeffs(12) = 2*data(12) + 2*data(15);
coeffs(13) = -1;
coeffs(14) = 1;
coeffs_ind = [4,4,4,4,3,3,2,2,4,1,4,12,4,8,3,3,2,2,4,1,4,12,3,4,3,5,2,4,2,9,4,1,3,2,4,12,8,11,3,8,2,8,4,1,8,3,3,2,4,3,...
5,2,3,2,4,2,9,4,1,3,2,4,12,11,8,3,14,8,8,3,2,8,2,14,3,3,8,7,6,3,12,5,2,6,2,8,10,2,12,9,4,1,3,5,2,9,12,8,11,14,...
8,14,8,14,3,8,8,2,8,8,1,8,14,7,6,3,14,7,6,6,10,3,2,6,10,2,14,3,3,7,5,2,6,9,3,12,5,2,3,6,5,2,10,9,2,12,9,4,1,3,...
5,2,9,12,11,14,8,7,5,14,8,6,6,8,5,9,8,10,9,14,3,8,7,5,6,5,8,11,7,6,5,14,7,6,6,10,5,9,6,10,9,14,3,7,5,6,9,5,11,13,...
13,2,6,8,10,9,9,8,11,1,5,9,8,11,14,13,13,13,2,6,5,10,9,9,11,1,5,9,11,14];
function C = setup_elimination_template(data)
[coeffs,coeffs_ind] = compute_coeffs(data);
C_ind = [10,38,52,80,96,124,139,167,180,182,208,210,221,253,267,295,310,338,351,353,379,381,395,421,423,425,438,462,466,468,478,481,490,499,503,509,510,511,522,533,565,585,605,608,638,652,664,673,678,680,...
682,695,706,715,719,723,725,735,738,747,756,760,766,768,793,808,817,835,845,849,851,887,892,903,908,918,919,920,929,933,937,939,951,963,969,971,972,976,978,982,991,994,1001,1006,1010,1015,1019,1024,1025,1032,...
1047,1073,1098,1116,1121,1130,1152,1164,1182,1193,1207,1234,1245,1266,1275,1280,1289,1308,1309,1317,1318,1321,1323,1351,1360,1364,1375,1380,1390,1392,1395,1400,1401,1404,1405,1409,1411,1423,1432,1435,1437,1441,1444,1446,1448,1450,1454,1463,1466,1473,...
1478,1482,1487,1491,1497,1504,1519,1520,1539,1545,1561,1563,1571,1572,1580,1582,1613,1614,1623,1631,1636,1645,1646,1649,1655,1664,1667,1668,1691,1701,1710,1716,1733,1734,1742,1744,1751,1753,1776,1785,1794,1802,1807,1817,1820,1826,1830,1835,1839,1890,...
1935,1937,1947,1955,1956,1958,1965,1966,1967,1980,1990,1999,2007,2008,2018,2060,2104,2149,2151,2161,2163,2170,2172,2179,2181,2194,2204,2213,2222,2232];
C = zeros(43,52);
C(C_ind) = coeffs(coeffs_ind);

